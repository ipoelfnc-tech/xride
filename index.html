import React, { useState, useEffect, useRef } from 'react';
import { 
  Terminal, Database, Truck, Code, Cpu, 
  Activity, Shield, Wifi, Zap, ChevronDown, 
  ExternalLink, Mail, Github, Linkedin, MousePointer2 
} from 'lucide-react';

const CONFIG = {
  frameCount: 95,
  scrollHeight: 5000, 
  // Pastikan URL ini adalah URL permanen untuk aset produksi Anda
  baseFrameUrl: "https://vhpycybcqstbpehnnadk.supabase.co/storage/v1/object/sign/tridi-bucket/frame_000_delay-0.042s.webp?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9kNWQ0MGJmZS00MzZmLTQwMTMtYTY0ZS1lNzc1NGYxZWZlZGIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJ0cmlkaS1idWNrZXQvZnJhbWVfMDAwX2RlbGF5LTAuMDQycy53ZWJwIiwiaWF0IjoxNzcxMTMyNjQ0LCJleHAiOjE3NzE3Mzc0NDR9.kfjqQr6uiJ754nbp1B5ToCVZHuapq-RXZJmVRSjphsA"
};

const CustomCursor = () => {
  const [pos, setPos] = useState({ x: 0, y: 0 });
  const [hovering, setHovering] = useState(false);

  useEffect(() => {
    const move = (e) => setPos({ x: e.clientX, y: e.clientY });
    const over = (e) => {
      const target = e.target;
      if (target && target.closest('button, a, .group')) setHovering(true);
      else setHovering(false);
    };
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseover', over);
    return () => {
      window.removeEventListener('mousemove', move);
      window.removeEventListener('mouseover', over);
    };
  }, []);

  return (
    <div 
      className="fixed pointer-events-none z-[9999] transition-transform duration-200 ease-out hidden md:block"
      style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}
      aria-hidden="true"
    >
      <div className={`relative -translate-x-1/2 -translate-y-1/2 ${hovering ? 'scale-150' : 'scale-100'} transition-transform duration-300`}>
        <div className="absolute w-8 h-8 border border-[#00f0ff] rounded-full opacity-20 animate-ping" />
        <div className="w-6 h-6 border-2 border-[#00f0ff] relative">
          <div className="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-1 bg-[#ff003c]" />
          <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-0.5 h-1 bg-[#ff003c]" />
          <div className="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0.5 bg-[#ff003c]" />
          <div className="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-0.5 bg-[#ff003c]" />
        </div>
      </div>
    </div>
  );
};

const CyberCard = ({ children, title, className = '', glow = 'cyan' }) => {
  const isPink = glow === 'pink';
  const borderStyle = isPink 
    ? "border-[#ff003c]/30 hover:border-[#ff003c]" 
    : "border-[#00f0ff]/30 hover:border-[#00f0ff]";

  return (
    <div className={`relative bg-[#0a0a0a]/90 backdrop-blur-xl border p-8 clip-bottom-right transition-all duration-500 group ${borderStyle} ${className}`}>
      <div className="absolute top-0 left-0 w-4 h-1 bg-[#00f0ff]" />
      <div className="absolute top-0 left-0 w-1 h-4 bg-[#00f0ff]" />
      <div className="absolute bottom-0 right-0 w-10 h-10 border-r-2 border-b-2 border-[#ff003c] translate-x-1 translate-y-1 opacity-50" />
      
      {title && (
        <div className="absolute -top-3 left-4 bg-[#050505] px-2 text-[10px] tracking-[4px] font-bold text-[#00f0ff] uppercase select-none">
          {title}
        </div>
      )}
      
      {children}
    </div>
  );
};

export default function App() {
  const [loading, setLoading] = useState(true);
  const [progress, setProgress] = useState(0);
  const [images, setImages] = useState([]);
  const canvasRef = useRef(null);
  const [frame, setFrame] = useState(0);

  // Preload aset gambar dengan penanganan error yang lebih baik
  useEffect(() => {
    let loaded = 0;
    const loadAssets = async () => {
      try {
        const promises = Array.from({ length: CONFIG.frameCount }).map(() => {
          return new Promise((resolve) => {
            const img = new Image();
            img.src = CONFIG.baseFrameUrl; 
            img.onload = () => {
              loaded++;
              setProgress((loaded / CONFIG.frameCount) * 100);
              resolve(img);
            };
            img.onerror = () => {
              loaded++;
              resolve(null); // Lewati frame yang rusak tapi tetap lanjut
            };
          });
        });
        const res = await Promise.all(promises);
        setImages(res.filter(img => img !== null));
        // Beri waktu jeda sedikit untuk transisi halus setelah loading selesai
        setTimeout(() => setLoading(false), 1000);
      } catch (err) {
        console.error("Critical Asset Failure", err);
        setLoading(false);
      }
    };
    loadAssets();
  }, []);

  // Handler Canvas dan Scroll
  useEffect(() => {
    const renderFrame = () => {
      if (!canvasRef.current || images.length === 0) return;
      const scrollY = window.scrollY;
      const maxScroll = CONFIG.scrollHeight - window.innerHeight;
      const fraction = Math.max(0, Math.min(1, scrollY / (maxScroll || 1)));
      const index = Math.min(images.length - 1, Math.floor(fraction * images.length));
      
      setFrame(index);

      const ctx = canvasRef.current.getContext('2d', { alpha: false }); // Optimasi performa ctx
      const img = images[index];
      if (img) {
        const { width: cw, height: ch } = canvasRef.current;
        const scale = Math.max(cw / img.width, ch / img.height);
        const x = (cw - img.width * scale) / 2;
        const y = (ch - img.height * scale) / 2;
        ctx.clearRect(0, 0, cw, ch);
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        // Efek overlay siber tipis
        ctx.fillStyle = 'rgba(0, 240, 255, 0.015)';
        ctx.fillRect(0, 0, cw, ch);
      }
    };

    const onResize = () => {
      if (canvasRef.current) {
        canvasRef.current.width = window.innerWidth;
        canvasRef.current.height = window.innerHeight;
        renderFrame();
      }
    };

    window.addEventListener('scroll', renderFrame, { passive: true });
    window.addEventListener('resize', onResize);
    onResize();

    return () => {
      window.removeEventListener('scroll', renderFrame);
      window.removeEventListener('resize', onResize);
    };
  }, [images, loading]);

  if (loading) {
    return (
      <div className="fixed inset-0 bg-[#050505] z-[999] flex flex-col items-center justify-center font-mono text-[#00f0ff]">
        <div className="relative w-64 h-1 bg-[#111] rounded-full overflow-hidden">
          <div 
            className="h-full bg-[#00f0ff] shadow-[0_0_20px_#00f0ff] transition-all duration-300 ease-out" 
            style={{ width: `${progress}%` }} 
          />
          <div className="absolute -top-8 left-0 text-[10px] tracking-[0.3em] uppercase animate-pulse">
            Sistem_Sedang_Diorganisir...
          </div>
          <div className="absolute -bottom-8 right-0 text-[10px] text-[#ff003c] font-bold">
            {Math.round(progress)}%
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-[#050505] text-gray-300 font-mono selection:bg-[#ff003c] selection:text-white min-h-screen antialiased">
      <CustomCursor />
      
      {/* Overlay Visual Permanen */}
      <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden" aria-hidden="true">
        <div className="absolute inset-0 opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
        <div className="absolute inset-0 scanlines"></div>
      </div>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;900&display=swap');
        
        body { overflow-x: hidden; background: #050505; }
        
        .scanlines {
          background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.5) 50%);
          background-size: 100% 4px;
        }
        
        .clip-bottom-right {
          clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
        }
        
        @keyframes glitch-anim {
          0% { transform: translate(0); }
          25% { transform: translate(-1px, 1px); }
          50% { transform: translate(-1px, -1px); }
          75% { transform: translate(1px, 1px); }
          100% { transform: translate(1px, -1px); }
        }
        
        .group:hover .glitch-active { animation: glitch-anim 0.15s infinite; }
      `}</style>

      {/* Hero Section dengan Scroll Canvas */}
      <div className="relative" style={{ height: `${CONFIG.scrollHeight}px` }}>
        <header className="sticky top-0 h-screen w-full flex flex-col items-center justify-center overflow-hidden">
          <canvas ref={canvasRef} className="absolute inset-0 w-full h-full object-cover grayscale opacity-60" />
          
          <div className={`relative z-10 text-center transition-all duration-1000 ${frame > 8 ? 'opacity-0 scale-90 blur-lg translate-y-20' : 'opacity-100'}`}>
            <div className="mb-6 inline-block px-4 py-1 border border-[#00f0ff] text-[#00f0ff] text-[10px] tracking-[0.5em] animate-pulse rounded-sm">
              JARINGAN_AMAN_TERHUBUNG
            </div>
            <h1 className="text-6xl md:text-9xl font-black text-white tracking-tighter mb-4 font-['Orbitron'] drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]">
              SAEFUL<span className="text-[#ff003c]">BAHRI</span>
            </h1>
            <div className="flex items-center justify-center gap-4 text-[#00f0ff] tracking-[0.4em] text-xs md:text-lg font-bold">
              <span className="opacity-30">/</span>
              <span>ARSITEK_DATA</span>
              <span className="opacity-30">/</span>
            </div>
            
            <div className="absolute -bottom-48 left-1/2 -translate-x-1/2 flex flex-col items-center gap-3 opacity-50">
              <span className="text-[10px] text-gray-400 uppercase tracking-[0.3em]">Gulir untuk Inisialisasi</span>
              <ChevronDown className="text-[#00f0ff] animate-bounce" size={18} />
            </div>
          </div>

          <div className="absolute left-6 bottom-6 hidden lg:block text-[9px] text-gray-600 font-bold space-y-1">
            <div className="flex items-center gap-2"><Wifi size={10} className="text-[#0aff0a]"/> ENKRIPSI: AKTIF</div>
            <div className="flex items-center gap-2"><Cpu size={10}/> CORE: X-9000_V2</div>
            <div className="flex items-center gap-2"><Activity size={10}/> STATUS: FRAME_{frame}</div>
          </div>
        </header>
      </div>

      <main className="relative z-20 bg-[#050505] px-6 pb-40">
        <div className="max-w-6xl mx-auto space-y-56">
          
          {/* Tentang / Profil */}
          <section id="about" className="grid grid-cols-1 lg:grid-cols-2 gap-20 items-center pt-32">
            <div className="space-y-8">
              <div className="inline-flex items-center gap-3 text-[#ff003c]">
                <div className="h-[2px] w-12 bg-[#ff003c]" />
                <span className="text-xs font-bold tracking-[0.4em]">DATA_PRIBADI</span>
              </div>
              <h2 className="text-4xl md:text-6xl font-black text-white font-['Orbitron'] leading-none uppercase tracking-tight">
                Membangun <br/> <span className="text-[#00f0ff]">Pipa Saraf Data</span>
              </h2>
              <p className="text-lg text-gray-400 leading-relaxed max-w-xl">
                Saya adalah arsitek data yang berfokus pada <span className="text-white font-bold">optimasi aliran informasi</span>. 
                Pengalaman saya di sektor logistik membentuk pola pikir tentang data sebagai aset vital yang harus mengalir dengan presisi, kecepatan, dan tanpa distorsi.
              </p>
              <div className="grid grid-cols-2 gap-4">
                <div className="p-5 border border-[#222] bg-[#0a0a0a] rounded-sm group hover:border-[#00f0ff] transition-colors">
                  <div className="text-[9px] text-gray-500 mb-1 uppercase tracking-widest">Kualifikasi_Akademik</div>
                  <div className="text-[#00f0ff] font-bold text-sm">Strata 1 (S1)</div>
                </div>
                <div className="p-5 border border-[#222] bg-[#0a0a0a] rounded-sm group hover:border-[#ff003c] transition-colors">
                  <div className="text-[9px] text-gray-500 mb-1 uppercase tracking-widest">Spesialisasi_Sistem</div>
                  <div className="text-[#ff003c] font-bold text-sm">Arsitektur Data</div>
                </div>
              </div>
            </div>

            <div className="relative">
              <div className="absolute -inset-4 border border-[#00f0ff]/10 animate-pulse pointer-events-none" />
              <CyberCard glow="cyan" title="STATISTIK_SISTEM">
                <div className="space-y-6 py-4">
                  {[
                    { label: 'EFISIENSI_ETL', val: '98%' },
                    { label: 'INTEGRITAS_DATA', val: '100%' },
                    { label: 'PENGURANGAN_LATENSI', val: '24ms' },
                  ].map((s, i) => (
                    <div key={i} className="group">
                      <div className="flex justify-between text-[10px] mb-2 font-bold">
                        <span className="text-gray-500 tracking-widest uppercase">{s.label}</span>
                        <span className="text-[#00f0ff]">{s.val}</span>
                      </div>
                      <div className="h-1 bg-[#1a1a1a] overflow-hidden rounded-full">
                        <div 
                          className="h-full bg-[#00f0ff] group-hover:shadow-[0_0_12px_#00f0ff] transition-all duration-1000 ease-out" 
                          style={{ width: s.val.includes('%') ? s.val : '80%' }} 
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </CyberCard>
            </div>
          </section>

          {/* Pengalaman / Log Operasional */}
          <section id="experience" className="space-y-20">
            <div className="text-center space-y-4">
              <h2 className="text-4xl md:text-5xl font-black text-white font-['Orbitron'] tracking-[0.2em] uppercase italic opacity-90">
                Log_Operasional
              </h2>
              <div className="h-1 w-24 bg-[#ff003c] mx-auto rounded-full shadow-[0_0_10px_#ff003c]" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <CyberCard glow="pink" title="LOG_01 // SEKTOR_LOGISTIK" className="md:translate-y-12">
                <div className="flex justify-between items-start mb-6">
                  <div>
                    <h3 className="text-2xl font-bold text-white uppercase tracking-tight">Operatif Logistik</h3>
                    <p className="text-[#ff003c] text-[10px] font-bold tracking-widest uppercase mt-1">2020 - SEKARANG</p>
                  </div>
                  <Truck className="text-[#ff003c] opacity-80" size={32} />
                </div>
                <p className="text-sm text-gray-400 leading-relaxed mb-8 border-l-2 border-[#ff003c]/20 pl-4 italic">
                  "Bertanggung jawab atas presisi distribusi aset fisik. Keahlian ini menjadi fondasi dalam memahami bagaimana infrastruktur data harus dikelola secara efisien."
                </p>
                <div className="flex flex-wrap gap-2">
                  <span className="px-2 py-1 bg-[#ff003c]/10 text-[#ff003c] text-[9px] font-bold rounded-sm border border-[#ff003c]/20">OPTIMASI_RUTE</span>
                  <span className="px-2 py-1 bg-[#ff003c]/10 text-[#ff003c] text-[9px] font-bold rounded-sm border border-[#ff003c]/20">KEAMANAN_ASET</span>
                </div>
              </CyberCard>

              <CyberCard glow="cyan" title="LOG_02 // TEKNOLOGI_DATA">
                <div className="flex justify-between items-start mb-6">
                  <div>
                    <h3 className="text-2xl font-bold text-white uppercase tracking-tight">Arsitek Neural</h3>
                    <p className="text-[#00f0ff] text-[10px] font-bold tracking-widest uppercase mt-1">KEAHLIAN_TEKNIS</p>
                  </div>
                  <Database className="text-[#00f0ff] opacity-80" size={32} />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  {['Python', 'SQL', 'Airflow', 'Spark', 'Kafka', 'BigQuery'].map(skill => (
                    <div key={skill} className="px-4 py-3 bg-[#0a0a0a] border border-[#222] text-[10px] text-gray-400 flex items-center gap-3 group hover:border-[#00f0ff] hover:text-white transition-all duration-300">
                      <div className="w-1 h-1 bg-[#00f0ff] group-hover:scale-150 transition-transform" />
                      {skill.toUpperCase()}
                    </div>
                  ))}
                </div>
              </CyberCard>
            </div>
          </section>

          {/* Kontak / Hubungi */}
          <section id="contact" className="pt-20 border-t border-[#1a1a1a]">
            <div className="flex flex-col items-center text-center">
              <div className="mb-16 space-y-6 max-w-2xl">
                <h2 className="text-5xl md:text-8xl font-black text-white font-['Orbitron'] tracking-tighter uppercase leading-[0.8]">
                  Siap_Untuk <br/> <span className="text-[#ff003c]">Kolaborasi?</span>
                </h2>
                <p className="text-gray-500 text-sm md:text-base leading-relaxed px-4">
                  Sistem saya terbuka untuk transmisi data baru. Jika Anda membutuhkan pengolahan data dengan presisi logistik, hubungi protokol komunikasi di bawah ini.
                </p>
              </div>

              <div className="flex flex-wrap justify-center gap-6 w-full px-4">
                {[
                  { label: 'GITHUB', icon: <Github size={20}/>, color: '#fff', url: '#' },
                  { label: 'LINKEDIN', icon: <Linkedin size={20}/>, color: '#00f0ff', url: '#' },
                  { label: 'EMAIL', icon: <Mail size={20}/>, color: '#ff003c', url: 'mailto:contact@saefulbahri.id' }
                ].map((link, i) => (
                  <a 
                    key={i}
                    href={link.url}
                    className="flex-1 min-w-[160px] max-w-[240px] flex items-center justify-center gap-4 px-6 py-5 bg-[#0a0a0a] border border-[#222] hover:border-[#00f0ff] hover:bg-[#00f0ff]/5 transition-all duration-500 group clip-bottom-right"
                  >
                    <span style={{ color: link.color }} className="group-hover:scale-110 transition-transform">{link.icon}</span>
                    <span className="font-bold tracking-[0.2em] text-xs group-hover:text-white">{link.label}</span>
                  </a>
                ))}
              </div>

              <footer className="mt-64 pb-10 opacity-20 hover:opacity-100 transition-opacity duration-1000">
                <div className="text-[9px] tracking-[1.5em] mb-3 uppercase font-bold text-[#00f0ff]">Saeful Bahri // Portfolio V1.0_PROD</div>
                <div className="text-[8px] tracking-[0.2em] uppercase">Membangun Masa Depan Data // 2026</div>
              </footer>
            </div>
          </section>

        </div>
      </main>
    </div>
  );
}
